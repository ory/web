(window.webpackJsonp=window.webpackJsonp||[]).push([[259],{1196:function(e,t,n){"use strict";n.r(t),t.default='$ curl -H "Accept: application/json" -s \\\n    \'http://127.0.0.1:4433/self-service/verification/flows?id=4fd52be5-5f80-4493-ab5c-90cb9bd331d2\' | jq\n\n{\n  "id": "4fd52be5-5f80-4493-ab5c-90cb9bd331d2",\n  "type": "api",\n  "expires_at": "2020-09-10T07:39:10.9503284Z",\n  "issued_at": "2020-09-10T06:39:10.9503284Z",\n  "request_url": "http://127.0.0.1:4433/self-service/verification/api",\n  "messages": null,\n  "methods": {\n    // ...\n  },\n  "state": "choose_method"\n}\n'},1197:function(e,t,n){"use strict";n.r(t),t.default="import {CommonApi} from '@ory/kratos-client'\n\nconst kratos = new CommonApi('http://127.0.0.1:4433/')\n\nconst flowId = '' // usually something like: req.query.flow\n\nkratos.getSelfServiceVerificationFlow(flowId)\n  .then(({body}) => {\n    console.log(body) // see the Raw HTTP tab for the payload\n  })\n"},1198:function(e,t,n){"use strict";n.r(t),t.default='package samples\n\nimport (\n  "fmt"\n\n  "github.com/ory/kratos-client-go/client/public"\n  "github.com/ory/kratos-client-go/client"\n\n  "github.com/ory/kratos/internal/httpclient/client/public"\n)\n\nfunc main() {\n  c := client.NewHTTPClientWithConfig(nil,\n    &client.TransportConfig{Host: "127.0.0.1:4433", BasePath: "/", Schemes: []string{"http"}})\n\n  flowID := "" // Usually something like: res.Request.URL.Query().Get("flow")\n\n  rs, err := c.Public.GetSelfServiceVerificationFlow(\n    public.NewGetSelfServiceVerificationFlowParams().\n      WithID(flowID),\n  )\n\n  fmt.Printf("%+v", rs.Payload) //\n}\n'},1199:function(e,t,n){"use strict";n.r(t),t.default='curl -s -v -X GET \\\n  -H "Accept: text/html"  \\\n  http://127.0.0.1:4433/self-service/verification/browser\n\n> GET /self-service/verification/browser HTTP/1.1\n> Host: 127.0.0.1:4433\n> User-Agent: curl/7.64.1\n> Accept: text/html\n>\n< HTTP/1.1 302 Found\n< Cache-Control: 0\n< Content-Type: text/html; charset=utf-8\n< Location: http://127.0.0.1:4455/verification?flow=df607aa1-d555-4b2a-b3e4-0f5a1d2fe6f3\n< Set-Cookie: csrf_token=y4Ocu6V83BapwJwbPw/pnlRHHw40DZbjq5iuDrxl0Ds=; Path=/; Domain=127.0.0.1; Max-Age=31536000; HttpOnly\n<\n<a href="http://127.0.0.1:4455/verification?flow=df607aa1-d555-4b2a-b3e4-0f5a1d2fe6f3">Found</a>.\n'},1200:function(e,t,n){"use strict";n.r(t),t.default='<a href="http://127.0.0.1:4433/self-service/verification/browser">Resend Verification Email</a>\n\n\x3c!-- or --\x3e\n\n<script>\n  const initverification = () => {\n    window.location.href = \'http://127.0.0.1:4433/self-service/verification/browser\'\n  }\n<\/script>\n\n<a onClick="initverification">Resend Verification Email</a>\n'},1201:function(e,t,n){"use strict";n.r(t),t.default="import React from 'react'\n\nconst MyComponent = () => (\n  <a href=\"http://127.0.0.1:4433/self-service/verification/browser\">Resend Verification Email</a>\n)\n"},1202:function(e,t,n){"use strict";n.r(t),t.default="express.get('/verification', function (req, res) {\n  res.redirect(302, 'http://127.0.0.1:4433/self-service/verification/browser')\n})\n"},1203:function(e,t,n){"use strict";n.r(t),t.default='<a href="http://127.0.0.1:4433/self-service/verification/browser">Resend Verification Email</a>\n'},1204:function(e,t,n){"use strict";n.r(t),t.default='$ curl -s -X GET \\\n  -H "Accept: application/json"  \\\n  http://127.0.0.1:4433/self-service/verification/api | jq\n\n{\n  "id": "4fd52be5-5f80-4493-ab5c-90cb9bd331d2",\n  "type": "api",\n  "expires_at": "2020-09-10T07:39:10.9503284Z",\n  "issued_at": "2020-09-10T06:39:10.9503284Z",\n  "request_url": "http://127.0.0.1:4433/self-service/verification/api",\n  "methods": {\n    // ...\n  },\n  "state": "choose_method"\n}\n'},1205:function(e,t,n){"use strict";n.r(t),t.default="import {PublicApi} from '@ory/kratos-client'\n\nconst kratos = new PublicApi('http://127.0.0.1:4433/')\nkratos.initializeSelfServiceVerificationViaAPIFlow()\n  .then(({body}) => {\n    console.log(body) // see the Raw HTTP tab for the payload\n  })\n"},1206:function(e,t,n){"use strict";n.r(t),t.default='package api\n\nimport (\n  "fmt"\n\n  "github.com/ory/kratos-client-go/client/public"\n  "github.com/ory/kratos-client-go/client"\n)\n\nfunc main() {\n  c := client.NewHTTPClientWithConfig(nil,\n    &client.TransportConfig{Host: "127.0.0.1:4433", BasePath: "/", Schemes: []string{"http"}})\n\n  rs, _ := c.Public.InitializeSelfServiceVerificationViaAPIFlow(public.\n    NewInitializeSelfServiceVerificationViaAPIFlowParams())\n\n  fmt.Printf("%+v", rs.Payload)\n}\n'},1207:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/browser-missing-b6126503634689b9ce786ceda596dfd4.png"},1208:function(e,t,n){"use strict";n.r(t),t.default='$ curl -H "Accept: application/json" -s \\\n    \'http://127.0.0.1:4433/self-service/verification/flows?id=73fcb010-da5c-4eb9-b329-3ed677a6897b\' | jq -r \'.methods.link.config\'\n\n{\n  "action": "http://127.0.0.1:4433/self-service/verification/methods/link?flow=73fcb010-da5c-4eb9-b329-3ed677a6897b",\n  "method": "POST",\n  "fields": [\n    {\n      "name": "csrf_token",\n      "type": "hidden",\n      "required": true,\n      "value": "xU9NtXUeGKKmLS95hXejOTo947GsndDzStKyxUUzjX4slitKpNSPro0SJtY1M7yTZXWL/g4LK3Fdrur1a2H8ag=="\n    },\n    {\n      "name": "email",\n      "type": "email",\n      "required": true,\n      "value": "",\n      "messages": [\n        {\n          "id": 4000002,\n          "text": "Property email is missing.",\n          "type": "error",\n          "context": {\n            "property": "email"\n          }\n        }\n      ]\n    }\n  ]\n}\n'},1209:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/browser-success-c3b7d7ce5719cdc93e91891ae9e321ae.png"},1210:function(e,t,n){"use strict";n.r(t),t.default='$ curl -H "Accept: application/json" -s \\\n    \'http://127.0.0.1:4433/self-service/verification/flows?id=ba0f508a-f2fb-435d-b5e2-0307db00d75d\' | jq\n\n{\n  "id": "ba0f508a-f2fb-435d-b5e2-0307db00d75d",\n  "type": "browser",\n  "expires_at": "2020-09-10T07:42:32.3468704Z",\n  "issued_at": "2020-09-10T06:42:32.3468704Z",\n  "request_url": "http://127.0.0.1:4433/self-service/verification/browser",\n  "active": "link",\n  "messages": [\n    {\n      "id": 1070002,\n      "text": "An email containing a verification link has been sent to the email address you provided.",\n      "type": "info",\n      "context": {}\n    }\n  ],\n  "methods": {\n    "link": {\n      "method": "link",\n      "config": {\n        "action": "http://127.0.0.1:4433/self-service/verification/methods/link?flow=ba0f508a-f2fb-435d-b5e2-0307db00d75d",\n        "method": "POST",\n        "fields": [\n          {\n            "name": "csrf_token",\n            "type": "hidden",\n            "required": true,\n            "value": "47dbOMg+HHU22BQuag9GpQLPE+ZceRgilVlZgyb/SbC73RgzSL6Pu1WnIPVoMQmS31ZTuKz6pEjVfPA7EJ1ZGw=="\n          },\n          {\n            "name": "email",\n            "type": "email",\n            "required": true,\n            "value": "aeneas@ory.sh"\n          }\n        ]\n      }\n    }\n  },\n  "state": "sent_email"\n}\n'},1211:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/browser-invalid-challenge-a588c20c6b645e2f27514c2f00d6e645.png"},1212:function(e,t,n){"use strict";n.r(t),t.default='$ curl -H "Accept: application/json" -s \\\n    \'http://127.0.0.1:4434/self-service/verification/flows?id=4eb06fb8-c7ef-4870-a842-44210b9ca15d\' | jq\n\n{\n  "id": "4eb06fb8-c7ef-4870-a842-44210b9ca15d",\n  "type": "browser",\n  "expires_at": "2020-09-10T07:48:26.0939369Z",\n  "issued_at": "2020-09-10T06:48:26.0939369Z",\n  "request_url": "http://127.0.0.1:4433/self-service/verification/methods/link?token=asdf",\n  "messages": [\n    {\n      "id": 4070001,\n      "text": "The verification token is invalid or has already been used. Please retry the flow.",\n      "type": "error",\n      "context": {}\n    }\n  ],\n  "methods": {\n    "link": {\n      "method": "link",\n      "config": {\n        "action": "http://127.0.0.1:4433/self-service/verification/methods/link?flow=4eb06fb8-c7ef-4870-a842-44210b9ca15d",\n        "method": "POST",\n        "fields": [\n          {\n            "name": "csrf_token",\n            "type": "hidden",\n            "required": true,\n            "value": "Cd0dy7E6OpYE9NfSyVJQcAPMmvdHbuDbmCQUe46bCyxRt17AMbqpWGeL4wnLbB9H3lXaqbftXLHYAb3DuPkbhw=="\n          },\n          {\n            "name": "email",\n            "type": "email",\n            "required": true\n          }\n        ]\n      }\n    }\n  },\n  "state": "choose_method"\n}\n'},1213:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/browser-challenge-completed-4a9dfbb911aa4085b72b6cee450d76ba.png"},1214:function(e,t,n){"use strict";n.r(t),t.default="$ curl -H \"Accept: application/json\" -s \\\n  'http://127.0.0.1:4434/self-service/verification/flows?id=eb2aa29b-a726-4477-8635-9d5830f543fc' \\\n  | jq -r '.state'\n\npassed_challenge\n"},545:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return j})),n.d(t,"metadata",(function(){return y})),n.d(t,"toc",(function(){return O})),n.d(t,"default",(function(){return T}));var i=n(3),a=n(8),r=(n(0),n(550)),o=n(553),s=n(551),l=n(569),c=n(570),d=n(571),f=n(572),u={curl:{label:"Raw HTTP",language:"shell",code:n(1196).default},js:{label:"JavaScript SDK",language:"js",code:n(1197).default},go:{label:"Go SDK",language:"go",code:n(1198).default}},m={curl:{label:"Raw HTTP",language:"shell",code:n(1199).default},html:{label:"HTML",language:"html",code:n(1200).default},jsx:{label:"ReactJS",language:"js",code:n(1201).default},node:{label:"ExpressJS",language:"html",code:n(1202).default},angular:{label:"Angular",language:"js",code:n(1203).default}},b={curl:{label:"Raw HTTP",language:"shell",code:n(1204).default},js:{label:"Node",language:"js",code:n(1205).default},go:{label:"Go",language:"go",code:n(1206).default}},p={browser:{label:"Browser UI",image:n(1207).default,alt:"Email Verification and Account Activation HTML Form with validation errors"},missing:{label:"Missing Email",language:"shell",code:n(1208).default}},h={browser:{label:"Browser UI",image:n(1209).default,alt:"Email Verification and Account Activation HTML Form with success message"},missing:{label:"Email Sent",language:"shell",code:n(1210).default}},v={browser:{label:"Browser UI",image:n(1211).default,alt:"Email Verification and Account Activation HTML Form with an invalid challenge"},missing:{label:"Invalid Challenge",language:"shell",code:n(1212).default}},g={browser:{label:"Browser UI",image:n(1213).default,alt:"Email Verification and Account Activation HTML Form with an invalid challenge"},missing:{label:"Success State",language:"shell",code:n(1214).default}},w=n(575),j={id:"verify-email-account-activation",title:"Email and Phone Verification and Account Activation"},y={unversionedId:"self-service/flows/verify-email-account-activation",id:"version-v0.5/self-service/flows/verify-email-account-activation",isDocsHomePage:!1,title:"Email and Phone Verification and Account Activation",description:"initBrowserFlow,",source:"@site/versioned_docs/version-v0.5/self-service/flows/verify-email-account-activation.mdx",sourceDirName:"self-service/flows",slug:"/self-service/flows/verify-email-account-activation",permalink:"/kratos/docs/v0.5/self-service/flows/verify-email-account-activation",editUrl:"https://github.com/ory/kratos/edit/master/docs/versioned_docs/version-v0.5/self-service/flows/verify-email-account-activation.mdx",version:"v0.5",lastUpdatedBy:"aeneasr",lastUpdatedAt:1607509062,formattedLastUpdatedAt:"12/9/2020",frontMatter:{id:"verify-email-account-activation",title:"Email and Phone Verification and Account Activation"},sidebar:"version-v0.5/docs",previous:{title:"Account Recovery and Password Reset",permalink:"/kratos/docs/v0.5/self-service/flows/account-recovery"},next:{title:"User Logout",permalink:"/kratos/docs/v0.5/self-service/flows/user-logout"}},O=[{value:"Account Activation",id:"account-activation",children:[]},{value:"Verification Methods",id:"verification-methods",children:[{value:"Verification <code>link</code> Method",id:"verification-link-method",children:[]}]},{value:"Initialize Verification Flow to Request or Resend Verification Challenge",id:"initialize-verification-flow-to-request-or-resend-verification-challenge",children:[{value:"Verification for Browser Clients",id:"verification-for-browser-clients",children:[]},{value:"Verification for API Clients",id:"verification-for-api-clients",children:[]}]},{value:"Verification Flow Payloads",id:"verification-flow-payloads",children:[{value:"Send Verification Link to Email",id:"send-verification-link-to-email",children:[]}]},{value:"Verification Flow Form Rendering",id:"verification-flow-form-rendering",children:[]},{value:"Verification Form Validation",id:"verification-form-validation",children:[{value:"Verification Link via Email",id:"verification-link-via-email",children:[]}]},{value:"Unsuccessful Verification",id:"unsuccessful-verification",children:[]},{value:"Successful Verification",id:"successful-verification",children:[]}],k={toc:O};function T(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(i.a)({},k,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"Please read the ",Object(r.b)("a",{parentName:"p",href:"../../self-service"},"Self-Service Flows")," overview before\ncontinuing with this document."))),Object(r.b)("p",null,"ORY Kratos allows users to verify their out-of-band (email, telephone number,\n...) communication channels. Verification can be initiated"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"after registration or by performing a verification flow;"),Object(r.b)("li",{parentName:"ul"},"manually by the user.")),Object(r.b)("p",null,"There are two Verification Flow types supported in ORY Kratos:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Flows where the user sits in front of the Browser (e.g. website, single page\napp, ...)"),Object(r.b)("li",{parentName:"ul"},"Flows where API interaction is required (e.g. mobile app, Smart TV, ...)")),Object(r.b)("p",null,"The Verification Flow can be summarized as the following state machine:"),Object(r.b)(s.a,{chart:'\nstateDiagram\n  s1: Flow is initialized\n  s2: User Interface renders Verification Flow Forms\n  s3: Update Verification Flow with Error Context(s)\n  s4: Verification challenge initiated (e.g. link via email)\n  s5: Verification completed\n  [*] --\x3e s1 : User clicks "Verify Email/SMS/..."\n  s1 --\x3e s2\n  s2 --\x3e s4 : User provides valid verification data\n  s2 --\x3e s3 : User provides invalid verification data\n  s3 --\x3e s2\n  s4 --\x3e s5 : Challenge response valid\n  s4 --\x3e s3 : Challenge response invalid\n  s5 --\x3e [*]\n',mdxType:"Mermaid"}),Object(r.b)("p",null,"To enable verification flows, make the following adjustments to your ORY Kratos\nconfiguration:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml",metastring:'title="path/to/config/kratos.yml"',title:'"path/to/config/kratos.yml"'},"selfservice:\n  methods:\n    link:\n      enabled: true\n  flows:\n    verification:\n      enabled: true\n")),Object(r.b)("h2",{id:"account-activation"},"Account Activation"),Object(r.b)("p",null,'Using this feature implements the so-called "account activation" with the\ndifference that ORY Kratos does not provide a feature that prevents signing into\naccounts without verified addresses. The reason being that verification is\nproving that the user controls the given address, but it is not an\nauthentication mechanism.'),Object(r.b)("p",null,"You may however choose to limit what an identity without verified addresses is\nable to do in your application logic or API Gateways."),Object(r.b)("h2",{id:"verification-methods"},"Verification Methods"),Object(r.b)("p",null,"Currently, ORY Kratos only supports one verification method:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"link")," method performs verification of email addresses.")),Object(r.b)("h3",{id:"verification-link-method"},"Verification ",Object(r.b)("inlineCode",{parentName:"h3"},"link")," Method"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"link")," method is dis/enabled in the ORY Kratos config:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml",metastring:'title="path/to/my/kratos/config.yml"',title:'"path/to/my/kratos/config.yml"'},"selfservice:\n  methods:\n    link:\n      enabled: true\n      # ...\n")),Object(r.b)("p",null,"Enabling this method will send out verification emails on new sign ups and when\na verified email address is updated."),Object(r.b)("p",null,"Before sending out a verification E-Mail, ORY Kratos will check if the email\naddress is already known. Depending on the result, one of the two flows will be\nexecuted:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Unknown email address: An email is sent to the address informing the recipient\nthat someone tried to verify this email address but that it is not known by\nthe system:",Object(r.b)("img",{alt:"Verification email for unknown address",src:Object(o.a)("img/docs/email-verify-unknown.png")})),Object(r.b)("li",{parentName:"ul"},"Known email address: An email which includes a verification link is sent to\nthe address:",Object(r.b)("img",{alt:"Verification email for known address",src:Object(o.a)("img/docs/email-verify-known.png")}))),Object(r.b)("p",null,"This prevents Account Enumeration Attacks as it is not possible for a threat\nagent to determine if an account exists or not based on the verification flow."),Object(r.b)("p",null,"The emails are using templates that can be customised as explained in\n",Object(r.b)("a",{parentName:"p",href:"/kratos/docs/v0.5/concepts/email-sms#templates"},"Customizing E-Mail Templates"),". The\ntemplate IDs are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Unknown email address: ",Object(r.b)("inlineCode",{parentName:"li"},"verification_invalid")),Object(r.b)("li",{parentName:"ul"},"Known email address: ",Object(r.b)("inlineCode",{parentName:"li"},"verification_valid"))),Object(r.b)("p",null,"You must define at least one Identity Traits field as a verification field. You\ncan do so by defining the following section in your Identity JSON Schema:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-diff"},' {\n   "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",\n   "$schema": "http://json-schema.org/draft-07/schema#",\n   "title": "Person",\n   "type": "object",\n   "properties": {\n     "traits": {\n       "type": "object",\n       "properties": {\n         "email": {\n           "type": "string",\n           "format": "email",\n           "ory.sh/kratos": {\n             "credentials": {\n               "password": {\n                 "identifier": true\n               }\n             },\n+            "verification": {\n+              "via": "email"\n+            }\n           }\n         }\n       }\n       "additionalProperties": false\n     }\n   }\n }\n')),Object(r.b)("p",null,"You can also combine this with the password method login identifier (see example\nabove). That way, the field ",Object(r.b)("inlineCode",{parentName:"p"},"email")," (or any field you define with these\nproperties) will serve as both the login identifier and as a verifiable email\naddress."),Object(r.b)("h2",{id:"initialize-verification-flow-to-request-or-resend-verification-challenge"},"Initialize Verification Flow to Request or Resend Verification Challenge"),Object(r.b)("p",null,"The first step is to initialize the Verification Flow. This sets up Anti-CSRF\ntokens and more. Each verification flow has a ",Object(r.b)("inlineCode",{parentName:"p"},"state")," parameter which follows\nthe state machine:"),Object(r.b)(s.a,{chart:"\nstateDiagram-v2\n\t[*] --\x3e choose_method\n\tchoose_method --\x3e sent_email\n\tsent_email --\x3e sent_email\n\tnote right of sent_email\n\t    The user may fill out the email form input again as a way to re-send the email.\n\tend note\n\tsent_email --\x3e passed_challenge\n\tpassed_challenge --\x3e [*]\n",mdxType:"Mermaid"}),Object(r.b)("p",null,"where"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"choose_method")," indicates that the user has not chosen a verification method\nyet. This is useful when ",Object(r.b)("inlineCode",{parentName:"li"},"link")," is not the only verification method active."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"sent_email")," implies that the verification email has been sent out."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"passed_challenge")," is set when the user has clicked the verification link and\ncompleted the account verification.")),Object(r.b)("h3",{id:"verification-for-browser-clients"},"Verification for Browser Clients"),Object(r.b)("p",null,"The Verification Flow for browser clients relies on HTTP redirects between ORY\nKratos, your Verification UI, and the end-user's browser:"),Object(r.b)(c.a,{flows:["verification"],success:"Set verified flag and redirect to successful Verification Flow",interactions:['"Verify Email"'],mdxType:"SelfServiceBrowserFlow"}),Object(r.b)("p",null,"To initialize the Verification Flow, point the Browser to\n",Object(r.b)("a",{parentName:"p",href:"../../self-service#initialization-and-redirect-to-ui"},"the initialization endpoint"),":"),Object(r.b)(f.a,{items:m,mdxType:"CodeTabs"}),Object(r.b)("p",null,"The server responds with a HTTP 302 redirect to the Verification UI, appending\nthe ",Object(r.b)("inlineCode",{parentName:"p"},"?flow=<flow-id>")," query parameter (see the curl example) to the URL\nconfigured here:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml",metastring:'title="path/to/config/kratos.yml"',title:'"path/to/config/kratos.yml"'},"selfservice:\n  flows:\n    verification:\n      # becomes http://127.0.0.1:4455/verification?flow=df607aa1-d555-4b2a-b3e4-0f5a1d2fe6f3\n      ui_url: http://127.0.0.1:4455/verification\n")),Object(r.b)("h3",{id:"verification-for-api-clients"},"Verification for API Clients"),Object(r.b)(l.a,{mdxType:"ApiWarning"}),Object(r.b)("p",null,"The Verification Flow for API clients does not use HTTP Redirects and can be\nsummarized as follows:"),Object(r.b)(d.a,{flows:["verification"],success:"Set verified flag to true",interactions:['"Verify Email"'],mdxType:"SelfServiceApiFlow"}),Object(r.b)("p",null,"To initialize the API flow, the client calls the API-flow initialization\nendpoint\n(",Object(r.b)("a",{parentName:"p",href:"/kratos/docs/v0.5/reference/api#initialize-verification-flow-for-api-clients"},"REST API Reference"),")\nwhich returns a JSON response:"),Object(r.b)(f.a,{items:b,mdxType:"CodeTabs"}),Object(r.b)("h2",{id:"verification-flow-payloads"},"Verification Flow Payloads"),Object(r.b)("p",null,"Fetching the Verification Flow\n(",Object(r.b)("a",{parentName:"p",href:"/kratos/docs/v0.5/reference/api#get-verification-flow"},"REST API Reference"),") is usually\nonly required for browser clients but also works for Verification Flows\ninitialized by API clients. All you need is a valid flow ID:"),Object(r.b)(f.a,{items:u,mdxType:"CodeTabs"}),Object(r.b)("h3",{id:"send-verification-link-to-email"},"Send Verification Link to Email"),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"The ",Object(r.b)("inlineCode",{parentName:"p"},"link")," verification mode will always open a link in the browser, even if it\nwas initiated by an API client. This is because the user clicks the link in\nhis/her email client, which opens the browser."))),Object(r.b)("p",null,"When the ",Object(r.b)("inlineCode",{parentName:"p"},"link")," method is enabled, it will be part of the ",Object(r.b)("inlineCode",{parentName:"p"},"methods")," payload in\nthe Verification Flow:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},'$ curl -H "Accept: application/json" -s \\\n    \'http://127.0.0.1:4434/self-service/verification/flows?id=4fd52be5-5f80-4493-ab5c-90cb9bd331d2\' | jq -r \'.methods.link.config\'\n\n{\n  "action": "http://127.0.0.1:4433/self-service/verification/methods/link?flow=4fd52be5-5f80-4493-ab5c-90cb9bd331d2",\n  "method": "POST",\n  "fields": [\n    {\n      "name": "csrf_token",\n      "type": "hidden",\n      "required": true,\n      "value": "l6jPm/3mDxYAODgv4SDitfCyfWD3+PH+loc5//E/UDFiJA9P3h6KCNKDyn/OpIrlEjv6Tf4Zaurp7KN/dD07Yg=="\n    },\n    {\n      "name": "email",\n      "type": "email",\n      "required": true\n    }\n  ]\n}\n')),Object(r.b)("h2",{id:"verification-flow-form-rendering"},"Verification Flow Form Rendering"),Object(r.b)("p",null,"The Verification User Interface is a route (page / site) in your application\n(server, native app, single page app) that should render a verification form."),Object(r.b)("p",null,"In stark contrast to other Identity Systems, ORY Kratos does not render this\nHTML. Instead, you need to implement the HTML code in your application (e.g.\nNodeJS + ExpressJS, Java, PHP, ReactJS, ...), which gives you extreme\nflexibility and customizability in your user interface flows and designs."),Object(r.b)("p",null,"You will use the Verification Flow JSON response to render the verification form\nUI, which could looks as follows depending on your programming language and web\nframework:"),Object(r.b)(w.a,{flow:"verification",mdxType:"RenderFlow"}),Object(r.b)("h2",{id:"verification-form-validation"},"Verification Form Validation"),Object(r.b)("p",null,"The form payloads are then submitted to ORY Kratos which follows up with:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"An HTTP 302 Found redirect pointing to the Verification UI for Browser\nClients."),Object(r.b)("li",{parentName:"ul"},"An ",Object(r.b)("inlineCode",{parentName:"li"},"application/json")," response for API Clients.")),Object(r.b)("h3",{id:"verification-link-via-email"},"Verification Link via Email"),Object(r.b)("p",null,"To send the verification email, the end-user fills out the form. There might be\nvalidation errors such as a malformed email:"),Object(r.b)(f.a,{items:p,mdxType:"CodeTabs"}),Object(r.b)("p",null,"When validation errors happen, browser clients receive a HTTP 302 Found redirect\nto the Verification Flow UI, containing the Verification Flow ID which includes\nthe error payloads."),Object(r.b)("p",null,"For API Clients, the server typically responds with HTTP 400 Bad Request and the\nVerification Flow in the response payload as JSON."),Object(r.b)("h4",{id:"successful-submission"},"Successful Submission"),Object(r.b)("p",null,"On successful submission, an email will be sent to the provided address:"),Object(r.b)(f.a,{items:h,mdxType:"CodeTabs"}),Object(r.b)("h2",{id:"unsuccessful-verification"},"Unsuccessful Verification"),Object(r.b)("p",null,"If the verification challenge (e.g. the link in the verification email) is\ninvalid or expired, the user will be HTTP 302 redirected to the Verification UI."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"When an invalid or expired challenge is used, ORY Kratos initializes a new\nAccount Verification flow automatically. This flow will always be a\nBrowser-based flow because the challenge is completed by clicking a link!"))),Object(r.b)("p",null,"The new Verification Flow includes an error message such as the following:"),Object(r.b)(f.a,{items:v,mdxType:"CodeTabs"}),Object(r.b)("p",null,"Please keep in mind that this part of the flow always involves a Browser!"),Object(r.b)("h2",{id:"successful-verification"},"Successful Verification"),Object(r.b)("p",null,"If the verification challenge is completed (e.g. the sent verification link was\nclicked), the end-user's Browser is redirected to the Verification UI with a\nVerification Flow that has now the ",Object(r.b)("inlineCode",{parentName:"p"},"state")," of ",Object(r.b)("inlineCode",{parentName:"p"},"passed_challenge"),":"),Object(r.b)(f.a,{items:g,mdxType:"CodeTabs"}),Object(r.b)("p",null,"You may also\n",Object(r.b)("a",{parentName:"p",href:"/kratos/docs/v0.5/concepts/browser-redirect-flow-completion"},"configure a redirect URL"),"\ninstead which would send the end-user to that configured URL."))}T.isMDXComponent=!0},551:function(e,t,n){"use strict";var i=n(0),a=n.n(i),r=n(573),o=n.n(r),s=n(57),l=n.n(s),c=n(567),d=n.n(c);o.a.initialize({startOnLoad:!0,logLevel:"fatal",securityLevel:"strict",arrowMarkerAbsolute:!1,theme:"neutral",flowchart:{useMaxWidth:!0,htmlLabels:!0,rankSpacing:65,nodeSpacing:30,curve:"basis"},sequence:{useMaxWidth:!0},gantt:{useMaxWidth:!0}});t.a=function(e){var t,n=e.chart,r=Object(i.useState)(!1),s=r[0],c=r[1],f=Object(i.useState)(void 0),u=f[0],m=f[1],b=Object(i.useState)("mermaid-"+Math.random().toString(36).substr(2,-1))[0],p=function(){return c(!s)};return Object(i.useEffect)((function(){o.a.render(b,n,(function(e){m(e)}))}),[]),a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{onClick:p,className:d()(l.a.graph,l.a.pointer),dangerouslySetInnerHTML:{__html:u}}),a.a.createElement("div",{onClick:p,className:d()(l.a.overlay,l.a.pointer,l.a.graph,(t={},t[l.a.visible]=s,t))},a.a.createElement("div",{onClick:function(e){return e.stopPropagation()},className:d()(l.a.backdrop,l.a.graph),dangerouslySetInnerHTML:{__html:u}})))}},565:function(e,t,n){"use strict";var i=n(0),a=n.n(i),r=n(566),o=n.n(r),s=n(559),l=n(60),c=n.n(l),d=function(e,t){if(!e)return 0;var n=t.findIndex((function(t){return t.indexOf(e)>-1}));return-1===n?0:n};t.a=function(e){var t=e.src,n=e.title,r=Object(i.useState)(""),l=r[0],f=r[1];Object(i.useEffect)((function(){var n,i,a;o()(t.replace("github.com","raw.githubusercontent.com").replace("/blob/","/")).then((function(e){return e.text()})).then((n=e,i=n.startAt,a=n.endAt,function(e){var t=e.split("\n"),n=d(i,t);n>0&&(t=["// ..."].concat(t.slice(n,-1)));var r=d(a,t);return r>0&&(t=[].concat(t.slice(0,r+1),["// ..."])),t.join("\n")})).then(f).catch(console.error)}),[]);var u="language-"+function(e){var t=e.split(".").pop();switch(t){case"jsx":return"jsx";case"tsx":return"tsx";case"ts":return"typescript";case"go":return"go";case"yaml":case"yml":return"yaml";case"js":return"javascript";case"html":return"html";case"pug":return"pug";default:return t}}(t),m='title="'+(n||function(e){var t=e.match(new RegExp("https://github.com/[^/]+/[^/]+/blob/[^/]+/(.+)","i"))||[];return t.length>=2?t[1]:e}(t))+'"';return a.a.createElement("div",{className:c.a.container},a.a.createElement(s.a,{metastring:m,className:u,children:l}))}},569:function(e,t,n){"use strict";var i=n(0),a=n.n(i);t.a=function(){return a.a.createElement("div",{className:"admonition admonition-warning alert alert--danger"},a.a.createElement("div",{className:"admonition-heading"},a.a.createElement("h5",null,a.a.createElement("span",{className:"admonition-icon"},a.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},a.a.createElement("path",{"fill-rule":"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),a.a.createElement("div",{className:"admonition-content"},a.a.createElement("p",null,"Never use API flows to implement Browser applications!"),a.a.createElement("p",null,"Using API flows in Single-Page-Apps as well as server-side apps opens up several potential attack vectors, including Login and other CSRF attacks.")))}},570:function(e,t,n){"use strict";var i=n(0),a=n.n(i),r=n(551);t.a=function(e){return a.a.createElement(a.a.Fragment,null,a.a.createElement(r.a,{chart:(t=e,n=t.flows,i=void 0===n?["login","registration","settings","..."]:n,o=t.interactions,s=void 0===o?['"Log in"','"Sign Up"','"Update Email"',"..."]:o,l=t.success,c=void 0===l?"Perform flow-specific action (e.g. create user, set session cookie, ...)":l,d=i.length>1?"<"+i.join("|")+">":""+i.join("|"),"\nsequenceDiagram\n\n  participant B as Browser\n  participant K as Ory Kratos\n  participant A as Flow UI\n\n  B->>K: Follow link to /self-service/"+d+"/browser\n  K--\x3e>K: Create and store new "+i.join(", ")+" flow\n  K->>B: HTTP 302 Found <selfservice.flows."+d+".ui_url>?flow=<flow-id>\n\n  B->>A: Opens <selfservice.flows.<"+i.join("|")+">.ui_url>?flow=<flow-id>\n  A--\x3e>K: Fetches data to render forms using /selfservice/"+d+"/flows?id=<flow-id>\n  B--\x3e>A: Fills out forms, clicks e.g. "+s.join(", ")+"\n  B->>K: Submits form\n  K--\x3e>K: Validates and processes form payloads\n\n  alt Form payload is valid\n    K->>B: "+c+"\n  else Form payload invalid\n    K--\x3e>K: Update and store flow (e.g. add form validation errors)\n    K--\x3e>B: HTTP 302 Found <selfservice.flows."+d+".ui_url>?flow=<flow-id>\n    B->>A: Opens <selfservice.flows."+d+"?flow=<flow-id>\n    A--\x3e>K: Fetches data to render form fields and errors\n    B->>K: Repeat flow with input data, submit, validate, ...\n  end\n")}),a.a.createElement("p",null,"The ",a.a.createElement("em",null,"Flow UI")," (",a.a.createElement("strong",null,"your application!"),') is responsible for rendering the actual Login and Registration HTML Forms. You can of course implement one app for rendering all the Login, Registration, ... screens, and another app (think "Service Oriented Architecture", "Micro-Services" or "Service Mesh") is responsible for rendering your Dashboards, Management Screens, and so on.'));var t,n,i,o,s,l,c,d}},571:function(e,t,n){"use strict";var i=n(0),a=n.n(i),r=n(551);t.a=function(e){return a.a.createElement(r.a,{chart:(t=e,n=t.flows,i=void 0===n?["login","registration","settings","..."]:n,o=t.interactions,s=void 0===o?['"Log in"','"Sign Up"','"Update Email"',"..."]:o,l=t.success,c=void 0===l?"Perform flow-specific action (e.g. create user, set session cookie, ...)":l,d=i.length>1?"<"+i.join("|")+">":""+i.join("|"),"\nsequenceDiagram\n  participant B as API Client\n  participant K as Ory Kratos\n\n  B->>K: REST GET /self-service/"+d+"/api\n  K--\x3e>K: Create and store new "+i.join(", ")+" flow\n  K->>B: HTTP 200 OK with flow as application/json payload\n  B--\x3e>B: Render form using e.g. Native iOS UI Elements\n  B--\x3e>B: User fills out forms, clicks e.g. "+s+"\n  B->>K: REST POST to e.g. /self-service/"+d+"?flow=...>\n  K--\x3e>K: Validates and processes payload\n  alt Form payload is valid\n    K->>B: "+c+"\n  else Form payload invalid\n    K--\x3e>K: Update and store flow (e.g. add form validation errors)\n    K->>B: Respond with e.g. HTTP 400 Bad Request and updated flow as payload\n    B--\x3e>B: Render form and validation errors using e.g. Native iOS UI Elements\n    B--\x3e>K: Repeat flow with input data, submit, validate, ...\n  end\n")});var t,n,i,o,s,l,c,d}},572:function(e,t,n){"use strict";var i=n(555),a=n(556),r=n(0),o=n.n(r),s=n(559);t.a=function(e){var t=e.items;return o.a.createElement(i.a,{defaultValue:Object.keys(t)[0],values:Object.keys(t).map((function(e){return{label:t[e].label,value:e}}))},Object.keys(t).map((function(e){return o.a.createElement(a.a,{key:e,value:e},t[e].code?o.a.createElement(s.a,{className:"language-"+t[e].language,children:t[e].code}):o.a.createElement("img",{src:t[e].image,alt:t[e].alt}))})))}},574:function(e,t,n){var i={"./locale":558,"./locale.js":558};function a(e){var t=r(e);return n(t)}function r(e){if(!n.o(i,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return i[e]}a.keys=function(){return Object.keys(i)},a.resolve=r,e.exports=a,a.id=574},575:function(e,t,n){"use strict";var i=n(555),a=n(556),r=n(0),o=n.n(r),s=n(565),l=n.p+"assets/images/browser-61597c2d37644d2e9a6cd62143a17d19.png",c=n.p+"assets/images/browser-3fffa4ddf3b8dbaa9171845af0b1ace3.png",d=n.p+"assets/images/browser-95c5fd81e495c104256cf0460ebd835a.png",f=n.p+"assets/images/browser-22673e53b8fd2d5b86732105f965b818.png";t.a=function(e){var t,n,r=e.flow;switch(r){case"registration":t=o.a.createElement("img",{src:d,alt:"User Registration HTML Form"});break;case"login":t=o.a.createElement("img",{src:l,alt:"User Login HTML Form"});break;case"settings":t=o.a.createElement("img",{src:c,alt:"Profile Settings HTML Form"});break;case"recovery":t=o.a.createElement("img",{src:f,alt:"Account Recovery HTML Form"});break;case"verification":t=o.a.createElement("img",{src:f,alt:"Email Verification HTML Form"})}return o.a.createElement(i.a,{defaultValue:"browser",values:[{label:"Browser UI",value:"browser"},{label:"ExpressJS & Handlebars",value:"express"},{label:"ReactJS",value:"react"},{label:"React Native",value:"react-native"}]},o.a.createElement(a.a,{value:"browser"},t),o.a.createElement(a.a,{value:"express"},o.a.createElement(s.a,{lang:"js",link:"https://github.com/ory/kratos-selfservice-ui-node/blob/master/src/routes/"+r+".ts",src:"https://raw.githubusercontent.com/ory/kratos-selfservice-ui-node/master/src/routes/"+r+".ts"}),"The views can be rather simple, as Ory Kratos provides you with all the information you need for rendering the forms. The following examples use Handlebars and a generic form generator to render the Flow:",o.a.createElement(i.a,{defaultValue:"view",values:[{label:(n=r,n.charAt(0).toUpperCase()+n.slice(1)+" View"),value:"view"},{label:"Generic Form View",value:"generic-form"},{label:"Example Input Form Element",value:"input-form"}]},o.a.createElement(a.a,{value:"view"},o.a.createElement(s.a,{lang:"handlebars",link:"https://github.com/ory/kratos-selfservice-ui-node/blob/master/views/"+r+".hbs",src:"https://raw.githubusercontent.com/ory/kratos-selfservice-ui-node/master/views/"+r+".hbs"})),o.a.createElement(a.a,{value:"generic-form"},o.a.createElement(s.a,{lang:"handlebars",link:"https://github.com/ory/kratos-selfservice-ui-node/blob/master/views/partials/ui.hbs",src:"https://raw.githubusercontent.com/ory/kratos-selfservice-ui-node/master/views/partials/ui.hbs"})),o.a.createElement(a.a,{value:"input-form"},o.a.createElement(s.a,{lang:"handlebars",link:"https://github.com/ory/kratos-selfservice-ui-node/blob/master/views/partials/ui_node_input_default.hbs",src:"https://raw.githubusercontent.com/ory/kratos-selfservice-ui-node/master/views/partials/ui_node_input_default.hbs"}))),"The rest of the form partials can be found"," ",o.a.createElement("a",{href:"https://github.com/ory/kratos-selfservice-ui-node/tree/master/views/partials"},"here"),"."),o.a.createElement(a.a,{value:"react"},"A React example is currently in the making."),o.a.createElement(a.a,{value:"react-native"},"A React Native example is currently in the making."))}}}]);