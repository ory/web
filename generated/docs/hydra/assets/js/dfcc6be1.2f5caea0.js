(self.webpackChunkdocusaurus_template=self.webpackChunkdocusaurus_template||[]).push([[265],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return d},kt:function(){return m}});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=a,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||i;return n?r.createElement(h,o(o({ref:t},d),{},{components:n})):r.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},32201:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return d},default:function(){return u}});var r=n(22122),a=n(19756),i=(n(67294),n(3905)),o=["components"],s={id:"merge-multiple-db-secrets",title:"Merge multiple Hydra instances with different system.secrets",sidebar_label:"Merge multiple system.secrets"},l=void 0,c={unversionedId:"guides/merge-multiple-db-secrets",id:"guides/merge-multiple-db-secrets",isDocsHomePage:!1,title:"Merge multiple Hydra instances with different system.secrets",description:"Be advised that this can break client creation if done incorrectly!",source:"@site/docs/guides/merge-multiple-db-secrets.mdx",sourceDirName:"guides",slug:"/guides/merge-multiple-db-secrets",permalink:"/hydra/docs/next/guides/merge-multiple-db-secrets",editUrl:"https://github.com/ory/hydra/edit/master/docs/docs/guides/merge-multiple-db-secrets.mdx",version:"current",lastUpdatedBy:"Vincent",lastUpdatedAt:1617965596,formattedLastUpdatedAt:"4/9/2021",frontMatter:{id:"merge-multiple-db-secrets",title:"Merge multiple Hydra instances with different system.secrets",sidebar_label:"Merge multiple system.secrets"},sidebar:"docs",previous:{title:"Migrating from MITREid",permalink:"/hydra/docs/next/guides/migrating-from-mitreid"},next:{title:"Advanced OAuth2 and OpenID Connect Flows",permalink:"/hydra/docs/next/advanced"}},d=[],p={toc:d};function u(e){var t=e.components,n=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Be advised that this can break client creation if done incorrectly!"),(0,i.kt)("p",{parentName:"div"},"Please follow this guide with caution and make sure you know what you are doing."))),(0,i.kt)("p",null,"This guide provides practical steps to merge multiple Ory Hydra Postgres\ndatabase instances with different ",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret")," values into one instance with\none ",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret"),"."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"$SECRETS_SYSTEM")," is an environmental variable, that is\nused to encrypt Ory Hydras database."),(0,i.kt)("p",null,"If you are looking for information on how to change (rotate) the\n",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret"),", please refer to the\n",(0,i.kt)("a",{parentName:"p",href:"https://www.ory.sh/hydra/docs/guides/secrets-key-rotation/#rotation-of-hmac-token-signing-and-database-and-cookie-encryption-keys"},"Secrets and Key Rotation Guide"),"."),(0,i.kt)("p",null,"First we take all the system.secret keys and add them to the target instance\nenvironment variables like so:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"SECRETS_SYSTEM=new-secret,secret-1,secret-2,secret-3,secret-n,secret-n+1")),(0,i.kt)("p",null,"Then we run the following\n",(0,i.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/9.3/app-pgdump.html"},"pg_dump command")," against\nthe databases we need to migrate:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"pg_dump --verbose -a  \\\n    --format=p \\\n    --no-owner \\\n    --no-acl \\\n    --quote-all-identifiers \\\n    -t hydra_client \\\n    -t hydra_oauth2_authentication_session \\\n    -t hydra_oauth2_authentication_request \\\n    -t hydra_oauth2_authentication_request_handled \\\n    -t hydra_oauth2_consent_request \\\n    -t hydra_oauth2_consent_request_handled \\\n    -t hydra_oauth2_code \\\n    -t hydra_oauth2_access \\\n    -t hydra_oauth2_refresh \\\n    -f hydra-dump.sql \\\n    <DSN>\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Take extra care with the following manual edits!")),(0,i.kt)("p",null,"Then we open each of the dump files and manually edit ",(0,i.kt)("inlineCode",{parentName:"p"},"hydra_clients.pk")," be\nentirely set to the value ",(0,i.kt)("inlineCode",{parentName:"p"},"DEFAULT"),"\n(",(0,i.kt)("a",{parentName:"p",href:"https://www.w3schools.com/sql/sql_ref_default.asp"},"SQL keyword"),") to make it\nfollow the sequence in the target DB correctly."),(0,i.kt)("p",null,"We delete the last line of the dump, since it sets the value of the primary key\nsequence to the number of the donor database.",(0,i.kt)("br",{parentName:"p"}),"\n","So we need to delete this line. ",(0,i.kt)("strong",{parentName:"p"},"This step is crucial!")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"If you don't remove it, it will potentially break client creation, since it\nwill reset the sequence of ",(0,i.kt)("inlineCode",{parentName:"em"},"hydra_clients.pk")," to what it was in the source DB")),(0,i.kt)("p",null,"After that the final step is to import the data like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"psql -o hydra_import_log \\\n -f hydra-dump.sql \\\n <DSN>\n")),(0,i.kt)("p",null,"And that did it, we successfully merged multiple Hydra instances with different\n",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret")," into one instance with one ",(0,i.kt)("inlineCode",{parentName:"p"},"system.secret"),"."))}u.isMDXComponent=!0}}]);